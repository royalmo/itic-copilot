var Dav=function(e,t){this.auth="Basic "+e,this.base=t},STATUS_CODES={100:"Continue",101:"Switching Protocols",102:"Processing",200:"OK",201:"Created",202:"Accepted",203:"None-Authoritive Information",204:"No Content",1223:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Time-out",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Large",415:"Unsupported Media Type",416:"Requested range not satisfiable",417:"Expectation Failed",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Time-out",505:"HTTP Version not supported",507:"Insufficient Storage"};Dav.prototype={request:function(o){var r=this._getXMLHttp();if(r.onreadystatechange=function(){var e,t,n;4==r.readyState&&(e=r.status.toString(),t=r.responseText,n=STATUS_CODES[e],o.handler&&o.handler(e,n,t),r=null)},r.open(o.type,o.path,!0),o.noAuth||r.setRequestHeader("Authorization",this.auth),o.headers)for(var e in o.headers){var t=o.headers[e];r.setRequestHeader(e,t)}r.send(o.content)},_getXMLHttp:function(){for(var e,t=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],n=0;e=t[n];n++)try{return(this._getXMLHttp=e)()}catch(e){}throw new Error("Your browser not supported XMLHttpRequest")},OPTIONS:function(r,i){var a=this;a.request({type:"OPTIONS",path:this.base,headers:{"Content-type":"text/xml;charset=utf-8"},handler:function(e,t,n){var o;"200"==e?(a.log("OPTIONS request success"),o=new RegExp(["<D:activity-collection-set>","<D:href>([^<]+)<\\/D:href>"].join("")),a.act=n.match(o)[1],a.uniqueKey=a._getUniqueKey(),a.log("Acitivity path is: "+a.act),r&&r(e,t,n)):(a.log("OPTIONS request fail",1),a.log(e+" "+t,1),a.log("OPTIONS INFO END",1),i&&i())},content:['<?xml version="1.0" encoding="utf-8"?>','<D:options xmlns:D="DAV:">',"<D:activity-collection-set/>","</D:options>"].join("")})},PROPFIND:function(o,r,e){var i=this;i.request({type:"PROPFIND",path:o,headers:{Depth:0,"Content-type":"text/xml;charset=utf-8"},content:['<?xml version="1.0" encoding="utf-8"?>','<D:propfind xmlns:D="DAV:">',e||"<D:allprop />","</D:propfind>"].join(""),handler:function(e,t,n){i.log("PROPFIND "+o+":"+e+" "+t),"207"==e&&i._parseResponse(n),r(e,t,n)}})},_parseResponse:function(e){var t,n=this.reg;for(t in n){var o=n[t],o=e.match(o);o&&(this[t]=o[1])}},reg:{vcc:new RegExp(["version-controlled-configuration>","<D:href>([^<]+)<\\/D:href>"].join("")),cki:/:checked-in><D:href>([^<]+)<\/D:href>/,cko:/<\w+>Checked-out resource (\S+) has been created/,blc:/:baseline-collection><D:href>([^<]+)<\/D/,blr:/:baseline-ralative-path>([^<]+)<\//},MKACTIVITY:function(o,r){var i=this;i.request({type:"MKACTIVITY",path:i.act+i.uniqueKey,handler:function(e,t,n){"201"==e?(i.log("MKACTIVITY request success"),i.log("Activity "+i.act+i.uniqueKey),i.log("MKACTIVITY INFO END"),o&&o(e,t,n)):(i.log("MKACTIVITY request fail",1),i.log(e+" "+t,1),r&&r())}})},CHECKOUT:function(o,r,e){var i=this,t=i.act+i.uniqueKey;i.request({type:"CHECKOUT",path:o,content:['<?xml version="1.0" encoding="utf-8"?>','<D:checkout xmlns:D="DAV:">',"<D:activity-set><D:href>",t,"</D:href>","</D:activity-set><D:apply-to-version/></D:checkout>"].join(""),handler:function(e,t,n){"201"==e?(i.log("CHECKOUT "+o+" done!"),i._parseResponse(n),r&&r(e,t,n)):(i.log("CHECKOUT "+o+" fail",1),i.log(e+" "+t,1),i.log("CHECKOUT INFO END"),i.rmact())}})},PROPPATCH:function(e,t,o,r){var i=this,t=i._getProppatchXML(t.set,t.del);i.request({type:"PROPPATCH",path:e,headers:{"Content-type":"text/xml;charset=utf-8"},content:['<?xml version="1.0" encoding="utf-8" ?>','<D:propertyupdate xmlns:D="DAV:"',' xmlns:V="http://subversion.tigris.org/xmlns/dav/"',' xmlns:C="http://subversion.tigris.org/xmlns/custom/"',' xmlns:S="http://subversion.tigris.org/xmlns/svn/">',t,"</D:propertyupdate>"].join(""),handler:function(e,t,n){"207"==e?(i.log("PROPPATCH success"),o&&o(e,t,n)):(i.log("PROPPATCH fail",1),i.log(e+" "+t,1),i.log("PROPPATCH INFO END",1),i.rmact(),r&&r())}})},PUT:function(e,t,o,r){var i=this,a=-1!=i.cko.indexOf(e)?i.cko:i.cko+"/"+e;i.request({type:"PUT",path:a,headers:{"Content-type":"text/plain"},content:t,handler:function(e,t,n){200<=e&&e<300?(i.log("PUT "+a+" success"),o&&o(e,e,t,n)):(i.log("PUT "+a+" fail",1),i.log(e+" "+t,1),i.log("PUT INFO END",1),i.rmact(),r&&r())}})},DELETE:function(e,o,r){var i=this,a="string"==typeof e?i.cko+"/"+e:e.join("");i.request({type:"DELETE",path:a,handler:function(e,t,n){200<=e&&e<300?(i.log("DELETE "+a+" done"),o&&o(e,t,n)):(i.log("DELETE "+a+" fail",1),i.log(e+" "+t,1),i.log("DELETE INFO END",1),r&&r())}})},MOVE:function(e,t,n){this.request({type:"MOVE",path:e,headers:{Destination:t,Overwrite:"F"},handler:function(e,t,n){}})},COPY:function(o,e,r){var i=this;i.request({type:"COPY",path:o,headers:{Destination:e,Overwrite:"F"},handler:function(e,t,n){200<=e&&e<300?(i.log("COPY "+o+" done!"),r&&r(e,t,n)):(i.log("COPY "+o+" fail",1),i.log(e+" "+t,1),i.rmact())}})},MKCOL:function(o,r,i){var a=this;a.request({type:"MKCOL",path:o,handler:function(e,t,n){200<=e&&e<300?(a.log("MKCOL "+o+" done!"),r&&r(e,t,n)):(a.log("MKCOL "+o+" fail.",1),a.rmact(),i&&i())}})},LOCK:function(){this.request({type:"LOCK",path:path,headers:{},handler:function(e,t,n){}})},UNLOCK:function(){this.request({type:"UNLOCK",headers:{},handler:function(e,t,n){}})},MERGE:function(o,r){var i=this;i.request({type:"MERGE",path:i.act+i.uniqueKey,headers:{"X-SVN-Options":"release-locks","Content-type":"text/xml;charset=utf-8"},content:['<?xml version="1.0" encoding="utf-8"?>','<D:merge xmlns:D="DAV:"><D:source>',"<D:href>",i.act,i.uniqueKey,"</D:href>","</D:source><D:no-auto-merge/><D:no-checkout/>","<D:prop><D:checked-in/><D:version-name/>","<D:resourcetype/><D:creationdate/>","<D:creator-displayname/></D:prop></D:merge>"].join(""),handler:function(e,t,n){"200"==e?(i.log("MERGE done"),i.rmact(o)):(i.log("MERGE fail",1),i.log(e+" "+t,1),i.log("##### MERGE INFO END",1),r&&r(e,t,n),i.rmact())}})},rmact:function(o){this.DELETE([this.act,this.uniqueKey],function(e,t,n){o&&o(e,t,n)})},_getUniqueKey:function(){for(var e=[],t=[8,4,4,4,12],n=0;n<5;n++){for(var o=t[n],r=[],i=0;i<o;i++)r.push(this._getRandomChar());e.push(r.join(""))}return e.join("-")},_getRandomChar:function(){return"0123456789abcdefghijklmnopqrstuvwxyz".charAt(Math.round(36*Math.random()))},log:function(e,t){var t=t?"red":"rgb(23, 199, 23)",n=document.createElement("p"),o=(new Date,this._getTime());n.style.color=t,n.innerHTML=o+" ==> "+e,Dav.console.appendChild(n)},_getTime:function(){var e=new Date;return[e.getHours(),e.getMinutes(),e.getSeconds()].join(":")},_getProppatchXML:function(e,t){var n=[];if(e){for(var o in n.push("<D:set>"),e)n.push("<D:prop>","<S:",o," >",e[o],"</S:",o,">","</D:prop>");n.push("</D:set>")}if(t){n.push("<D:remove>");for(var r=0;o=t[r];r++)n.push("<D:prop>","<S:",o," />","</D:prop>");n.push("</D:remove>")}return n.join("")}},function(){var e=Dav.console=document.createElement("div"),t=(document.documentElement.clientHeight,e.style.cssText=[].join(""),document.createElement("button"));t.innerHTML="Hide",e.appendChild(t),t.onclick=function(){e.style.display="none"},document.body.appendChild(e)}(),this.SVN=function(e,t,n){e=btoa(e+":"+t);this.dav=new Dav(e,n),this.handlers=[]},this.SVN.prototype={add:function(e,t){this.handlers.push({method:"PUT",params:[e,t]})},del:function(e){this.handlers.push({method:"DELETE",params:[e]})},copy:function(e,t){},move:function(e,t){},lock:function(){},unlock:function(){},mkdir:function(e){this.handlers.push({method:"MKCOL",params:[e]})},propset:function(e,t){this.handlers.push({method:"PROPPATCH",params:[e,{set:t}]})},propdel:function(e,t){this.handlers.push({method:"PROPPATCH",params:[e,{del:t}]})},commit:function(e,t,n){var o=this,r=o.dav;o.message=e,o.ok=t,o.err=n,r.log("================================================"),r.OPTIONS(function(){r.PROPFIND(r.base,function(e){"207"==e?o._mkAct():o.err&&o.err()})})},log:function(){Dav.console.style.display="block"},_mkAct:function(){var e=this,t=e.dav;t.MKACTIVITY(function(){t.CHECKOUT(t.vcc,function(){e._patchLog()},function(){e.err&&e.err()})},function(){e.err&&e.err()})},_patchLog:function(){var e=this,t=e.dav,n=e.message;t.PROPPATCH(t.cko,{set:{log:n}},function(){e._process()},function(){e.err&&e.err()})},_process:function(){var e=this,t=e.dav,n=e.handlers.shift(),o=n.method,r=n.params,n=(r.push(function(){e.handlers.length?e._process():e._merge()},function(){e.err&&e.err()}),e._getCheckoutUrl(o,r[0]));t.CHECKOUT(n,function(){if("COPY"==o)return e._prepareCopy(r);"PROPPATCH"==o?r[0]=t.cko:"MKCOL"==o&&(r[0]=t.cko+"/"+r[0]),t[o].apply(t,r)},function(){e.err&&e.err()})},_prepareCopy:function(r){var i=this.dav,a=r[1],s=r[2];i.PROPFIND(a,function(){i.PROPFIND(i.vcc,function(e,t,n){var o=r[0],o=i.cko+"/"+("./"==o?"":o);a=n.match(/:baseline-collection><D:href>([^<]+)<\/D/)[1]+n.match(/:baseline-ralative-path>([^<]+)<\//)[1]+"/"+a,i.COPY(a,o,s)})})},_getCheckoutUrl:function(e,t){var n=this.dav,o=n.cki;if("./"==t&&"COPY"==e)return n.cki;n=t.indexOf("/");return("PROPPATCH"==e||-1<n)&&(o+="/"+t),o},_merge:function(){var e=this,t=e.dav;t.MERGE(function(){t.log("ALL DONE!"),t.log("================================================"),e.ok&&e.ok()},function(){e.err&&e.err()})}},function(e){e.rm=e.remove=e.delete=e.del,e.mv=e.rename=e.ren=e.move,e.up=e.update,e.pset=e.ps=e.propset,e.pdel=e.pd=e.propdel}(this.SVN.prototype);